name: Build

on:
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # Need to use a PAT so this will trigger the release action
          token: ${{ secrets.BMASTERS_TOKEN }}
      - name: Build Chart
        env:
          IMAGE: ${{ github.event.inputs.image }}
          IMAGE_TAG: ${{ github.event.inputs.tag }}
          GIT_COMMITTER_NAME: Butch Masters
          GIT_COMMITTER_EMAIL: b-masters@users.noreply.github.com
          GIT_AUTHOR_NAME: ${{ github.actor }}
          GIT_AUTHOR_EMAIL: ${{ github.actor }}@users.noreply.github.com
        run: |-
          IMAGE_TAG="${IMAGE_TAG#v}"
          ./build.sh
          if git commit -a \
            -m "Update chart from image" \
            -m "${IMAGE}@$(docker images --no-trunc -q ${IMAGE}:${IMAGE_TAG})" ; then
            git push
          else
            echo "::warning title=No changes::There were no changes made by this build."
          fi
